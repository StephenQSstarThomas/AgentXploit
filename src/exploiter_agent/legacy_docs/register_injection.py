"""
Register agent-generated injection prompts to file.
Simple tool: takes optimized prompt, saves to file, returns path.
"""
import json
import logging
import os
import time
from typing import Optional

logger = logging.getLogger(__name__)


def register_injection(
    injection_content: str,
    agent_type: Optional[str] = None
) -> dict:
    """Save agent-generated injection prompt to file.

    Args:
        injection_content: The optimized injection prompt (text or JSON string)
        agent_type: Target agent type (agentdojo/openhands), defaults to agentdojo

    Returns:
        dict: {
            "success": bool,
            "local_file_path": str,  # Path for run_target_agent()
            "container_path": str,   # Where it will be in container
            "message": str
        }
    """
    try:
        agent_type = agent_type or "agentdojo"
        timestamp = time.strftime("%Y%m%d_%H%M%S")

        # Prepare local directory - use absolute path
        script_dir = os.path.dirname(os.path.abspath(__file__))
        exploiter_dir = os.path.dirname(script_dir)  # Go up from tools/ to exploiter_agent/
        local_dir = os.path.join(exploiter_dir, "reports", "injections")
        os.makedirs(local_dir, exist_ok=True)
        logger.info(f"Using injection directory: {local_dir}")

        # Determine filename and container path
        if agent_type == "agentdojo":
            filename = f"injection_{timestamp}.json"
            container_path = "/work/injections.json"
        else:
            filename = f"injection_{timestamp}.txt"
            container_path = "/tmp/injected_prompt.txt"

        local_path = os.path.join(local_dir, filename)

        # Write file
        if agent_type == "agentdojo":
            try:
                json_data = json.loads(injection_content) if isinstance(injection_content, str) else injection_content
                with open(local_path, 'w') as f:
                    json.dump(json_data, f, indent=2)
            except json.JSONDecodeError:
                # Fallback: treat as raw string
                with open(local_path, 'w') as f:
                    f.write(injection_content)
        else:
            with open(local_path, 'w') as f:
                f.write(injection_content)

        logger.info(f"Injection registered: {local_path} (agent_type={agent_type})")

        return {
            "success": True,
            "local_file_path": local_path,
            "container_path": container_path,
            "message": f"Injection saved to {filename}"
        }

    except Exception as e:
        logger.error(f"Failed to register injection: {e}")
        return {
            "success": False,
            "local_file_path": None,
            "container_path": None,
            "message": f"Error: {str(e)}"
        }


__all__ = ["register_injection"]
