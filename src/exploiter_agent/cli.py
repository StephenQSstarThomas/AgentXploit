#!/usr/bin/env python3
"""
Exploiter Agent CLI

Command-line interface for running the exploiter agent in different modes:
- FILE mode: For document/file-based prompt injection attacks
- NETWORK mode: For network-based CVE/API vulnerability exploits
"""
import os
import sys
import argparse
from pathlib import Path
from dotenv import load_dotenv

# Add parent directory to path for imports
sys.path.insert(0, str(Path(__file__).parent))

from exploiter_agent import ExploitAgent, MODE_FILE, MODE_NETWORK


def main():
    load_dotenv()

    parser = argparse.ArgumentParser(
        description='Exploiter Agent - AI Security Vulnerability Exploitation',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  # File-based mode (prompt injection via documents)
  python cli.py /path/to/task --mode file --max-turns 15

  # Network-based mode (CVE exploits via HTTP APIs)
  python cli.py /path/to/task --mode network --max-turns 20

  # Network mode with custom container name
  python cli.py /path/to/task --mode network --container my-attacker --max-turns 20
"""
    )

    parser.add_argument('task_path', type=str,
                        help='Path to task directory containing task_config.json or task.yaml')
    parser.add_argument('--mode', type=str, choices=['file', 'network'], default='file',
                        help='Exploitation mode: "file" for document-based attacks, "network" for CVE/API exploits (default: file)')
    parser.add_argument('--container', type=str, default=None,
                        help='Docker container name for network mode (default: agentscope-attacker-<task_id>)')
    parser.add_argument('--max-turns', type=int, default=15,
                        help='Maximum number of agent turns (default: 15)')
    parser.add_argument('--config', type=str, default='config.yaml',
                        help='Path to agent configuration file (default: config.yaml)')

    args = parser.parse_args()

    # Validate task path
    task_path = os.path.abspath(args.task_path)
    if not os.path.isdir(task_path):
        print(f"Error: Task directory not found: {task_path}")
        sys.exit(1)

    # Check for task config files
    config_exists = (
        os.path.exists(os.path.join(task_path, "task_config.json")) or
        os.path.exists(os.path.join(task_path, "task.yaml"))
    )
    if not config_exists:
        print(f"Warning: No task_config.json or task.yaml found in {task_path}")

    print(f"=" * 60)
    print(f"Exploiter Agent")
    print(f"=" * 60)
    print(f"Mode: {args.mode.upper()}")
    print(f"Task Path: {task_path}")
    print(f"Max Turns: {args.max_turns}")
    if args.mode == 'network':
        print(f"Container: {args.container or 'auto-detect'}")
    print(f"=" * 60)
    print()

    try:
        agent = ExploitAgent(
            mode=args.mode,
            container_name=args.container,
            config_path=args.config
        )
        result = agent.run(
            task_path=task_path,
            max_iteration_turn=args.max_turns
        )

        print()
        print(f"=" * 60)
        print(f"Result: {'SUCCESS' if result.get('exploit_success') else 'FAILED'}")
        print(f"Mode: {result.get('mode', 'unknown')}")
        if result.get("log_file"):
            print(f"Log File: {result['log_file']}")
        if result.get("error"):
            print(f"Error: {result['error']}")
        print(f"=" * 60)

        sys.exit(0 if result.get('exploit_success') else 1)

    except Exception as e:
        print(f"\nError: {e}")
        sys.exit(1)


if __name__ == '__main__':
    main()
