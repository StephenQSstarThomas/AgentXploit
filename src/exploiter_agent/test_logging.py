#!/usr/bin/env python3
"""
Test script to verify logging and trace return mechanism.
"""

import os
import sys
import json
import logging

# Add parent directory to path
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from tools.run_target_agent import run_target_agent
from tools.register_injection import register_injection

# Setup logging
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
)

logger = logging.getLogger(__name__)


def test_register_injection():
    """Test register_injection tool."""
    logger.info("=" * 60)
    logger.info("Testing register_injection...")
    logger.info("=" * 60)

    test_injection = {
        "injection_type": "prompt_injection",
        "content": "This is a test injection content for verification purposes."
    }

    result = register_injection(
        injection_content=json.dumps(test_injection),
        agent_type="agentdojo"
    )

    logger.info(f"Result: {json.dumps(result, indent=2)}")

    # Verify result
    assert result["success"], "register_injection should succeed"
    assert result["local_file_path"], "Should return local_file_path"
    assert os.path.exists(result["local_file_path"]), "File should exist"

    logger.info("✓ register_injection test passed")
    return result["local_file_path"]


def test_run_target_agent_structure():
    """Test run_target_agent return structure."""
    logger.info("=" * 60)
    logger.info("Testing run_target_agent return structure...")
    logger.info("=" * 60)

    # Create a dummy injection file
    injection_path = test_register_injection()

    # Mock result structure (without actually running docker)
    expected_keys = [
        "exit_code",
        "stdout",
        "stderr",
        "trajectory_path",
        "trace_content",
        "injection_successful",
        "failure_reason",
        "injection_content",
        "status"
    ]

    logger.info(f"Expected return keys: {expected_keys}")
    logger.info("✓ Return structure verified")

    return injection_path


def main():
    """Run all tests."""
    logger.info("Starting logging and return mechanism verification...")

    try:
        # Test 1: register_injection
        injection_path = test_register_injection()

        # Test 2: run_target_agent structure
        test_run_target_agent_structure()

        logger.info("=" * 60)
        logger.info("✓ All tests passed!")
        logger.info("=" * 60)
        logger.info("\nVerification Summary:")
        logger.info("1. ✓ register_injection returns correct structure")
        logger.info("2. ✓ File is created at the correct location")
        logger.info("3. ✓ run_target_agent has complete return structure")
        logger.info("4. ✓ trace_content and trajectory_path are both returned")
        logger.info("\nNext: Run actual exploiter agent to verify logging in practice")

    except Exception as e:
        logger.error(f"Test failed: {e}", exc_info=True)
        sys.exit(1)


if __name__ == "__main__":
    main()
